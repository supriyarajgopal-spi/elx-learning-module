<?php

/**
 * @file
 * Drupal needs this blank file.
 */

/**
 * Implements hook_form_FORM_ID_alter().
 */
function content_conversion_form_content_object_node_form_alter(&$form, &$form_state) {
  $node = $form_state['node'];
  if (!empty($node->nid)) {
    $form['actions']['h5p'] = array(
      '#type' => 'submit',
      '#value' => t('Generate H5P content'),
      '#weight' => 15,
      '#submit' => array('content_conversion_h5p_submit'),
    );
  }
}

/**
 * Form submission handler for node_form().
 *
 * Generates interactive content node for content object node.
 *
 * @see content_conversion_form_content_object_node_form_alter()
 * @see node_form_validate()
 */
function content_conversion_h5p_submit($form, &$form_state) {
  $h5p_node = content_conversion_content_object_h5p($form_state['node']);
  $form_state['redirect'] = entity_uri('node', $h5p_node);
}

/**
 * Generates an interactive content node for a Content Object node.
 *
 * @param object $node
 *   A Content Object node.
 */
function content_conversion_content_object_h5p($node) {
  if (!empty($node->field_h5p_node[LANGUAGE_NONE][0]['target_id'])) {
    $h5p_node = node_load($node->field_h5p_node[LANGUAGE_NONE][0]['target_id']);
  }
  if (empty($h5p_node)) {
    $h5p_node = array();
  }
  else {
    $h5p_node = array(
      'nid' => $h5p_node->nid,
      'vid' => $h5p_node->vid,
    );
  }
  $h5p_node += array(
    'uid' => $node->uid,
    'name' => $node->name,
    'type' => 'h5p_content',
    'language' => $node->language,
    'title' => $node->title,
    'status' => $node->status,
    'promote' => $node->promote,
    'sticky' => $node->sticky,
    'created' => $node->created,
    'revision' => FALSE,
    'comment' => $node->comment,
    'h5p_type' => 'create',
    'main_library_id' => h5peditor_get_library_property('H5P.CoursePresentation 1.11', 'libraryId'),
    'json_content' => content_conversion_h5p_json($node),
    'embed_type' => 'div',
    'disable' => 0,
    'h5p_library' => 'H5P.CoursePresentation 1.11',
  );
  $h5p_node = (object) $h5p_node;
  node_save($h5p_node);
  $node->field_h5p_node[LANGUAGE_NONE][0]['target_id'] = $h5p_node->nid;
  node_save($node);
  return $h5p_node;
}

/**
 * Generates H5P JSON code from a Content Object node.
 *
 * @param object $content_object
 *   A Content Object node.
 */
function content_conversion_h5p_json($content_object) {
  $h5p = new stdClass();
  // Convert the Content Object node into a Course Presentation.
  $h5p->presentation = new stdClass();
  $h5p->presentation->slides = array();
  // Convert learning object nodes into Course Presentation slides.
  foreach ($content_object->field_learning_objects[$content_object->language] as $learning_object) {
    $slide = new stdClass();
    $h5p->presentation->slides[] = $slide;
    $node = node_load($learning_object['target_id']);
    $function = '_content_conversion_node_' . $node->type;
    if (function_exists($function)) {
      $function($node, $slide);
    }
  }
  return json_encode($h5p);
}

/**
 * Converts a List node to H5P slide data.
 *
 * @param object $node
 *   A List node.
 * @param object $slide
 *   H5P data for a single slide.
 */
function _content_conversion_node_list($node, $slide) {
  foreach ($node->field_list_item[$node->language] as $item) {
    $paragraph = paragraphs_item_load($item['value']);
    $slide->elements = array();
    $element = new stdClass();
    $element->x = 1.0615711252654;
    $element->y = 6.2893081761006;
    $element->width = 68.789808917197;
    $element->height = 56.184486373166;
    $action = new stdClass();
    $action->library = 'H5P.Video 1.2';
    $params = new stdClass();
    $visuals = new stdClass();
    $visuals->fit = TRUE;
    $visuals->controls = TRUE;
    $params->visuals = $visuals;
    $playback = new stdClass();
    $playback->autoplay = FALSE;
    $playback->loop = FALSE;
    $params->playback = $playback;
    $l10n = new stdClass();
    $l10n->name = 'Video';
    $l10n->loading = 'Video player loading...';
    $l10n->noPlayers = 'Found no video players that support the given video format.';
    $l10n->noSources = 'Video is missing sources.';
    $l10n->aborted = 'Media playback has been aborted.';
    $l10n->networkFailure = 'Network failure.';
    $l10n->cannotDecode = 'Unable to decode media.';
    $l10n->formatNotSupported = 'Video format not supported.';
    $l10n->mediaEncrypted = 'Media encrypted';
    $l10n->unknownError = 'Unknown error.';
    $l10n->invalidYtId = 'Invalid YouTube ID.';
    $l10n->unknownYtId = 'Unable to find video with the given YouTube ID.';
    $l10n->restrictedYt = 'The owner of this video does not allow it to be embedded.';
    $params->l10n = $l10n;
    $params->sources = array();
    if (!empty($paragraph->field_list_video)) {
      foreach ($paragraph->field_list_video[LANGUAGE_NONE] as $file) {
        $source = new stdClass();
        $source->path = file_create_url($file['uri']);
        $source->mime = $file['filemime'];
        $copyright = new stdClass();
        $copyright->license = 'U';
        $source->copyright = $copyright;
        $params->sources[] = $source;
      }
    }
    $action->params = $params;
    $element->action = $action;
    $element->alwaysDisplayComments = FALSE;
    $element->backgroundOpacity = 0;
    $element->displayAsButton = FALSE;
    $element->invisible = FALSE;
    $element->solution = '';
    $slide->elements[] = $element;
    // Avoid creating empty text box by stripping tags from safe value and
    // trimming white space and non-breaking space.
    $safe = trim(strip_tags($paragraph->field_list_text[LANGUAGE_NONE][0]['safe_value']), " \t\n\r\0\x0B\xC2\xA0");
    if ($safe != '') {
      $element = new stdClass();
      $element->x = 1.0615711252654;
      $element->y = 67.027044025157;
      $element->width = 96.390658174098;
      $element->height = 28.930817610063;
      $action = new stdClass();
      $action->library = 'H5P.AdvancedText 1.1';
      $params = new stdClass();
      $params->text = $paragraph->field_list_text[LANGUAGE_NONE][0]['value'];
      $action->params = $params;
      $element->action = $action;
      $element->alwaysDisplayComments = FALSE;
      $element->backgroundOpacity = 0;
      $element->displayAsButton = FALSE;
      $element->invisible = FALSE;
      $element->solution = '';
      $slide->elements[] = $element;
    }
  }
}

/**
 * Converts a Story node to H5P slide data.
 *
 * @param object $node
 *   A Story node.
 * @param object $slide
 *   H5P data for a single slide.
 */
function _content_conversion_node_story($node, $slide) {

  $slide->elements = array();
  $slide->slideBackgroundSelector = new stdClass();
  $slide->keywords = array();

  $get_text_array = array(
    "text" => $node->field_story_copy[$node->language][0]['safe_value'],
    "label" => $node->field_story_label[$node->language][0]['value'],
    "x" => '1.0615711252654',
    "y" => '2.0898846960168',
    "width" => '98.513800424628',
    "height" => '58.280922431866',
  );
  $slide->elements[] = _create_text_object($get_text_array);

  if (!empty($node->field_story_image[$node->language][0]['uri'])) {
    $element = new stdClass();
    $element->x = 1.0615711252654;
    $element->y = 59.538784067086;
    $element->width = 30.430461002119;
    $element->height = 40;
    $element->alwaysDisplayComments = false;
    $element->backgroundOpacity = 0;
    $element->displayAsButton = false;
    $element->invisible = false;
    $element->solution = '';

    $params = new stdClass();
    $params->contentName = "Image";
    $params->alt = "Image for the slide";
    $params->file = _create_image_object($node->field_story_image[$node->language][0]);

    $action = new stdClass();
    $action->library = "H5P.Image 1.0";
    $action->subContentId = 0;
    $action->params = $params;
    $element->action = $action;
    $slide->elements[] = $element;
  }
}

/**
 * Created by SUPRIYA RAJGOPAL on 25Aug16
 *
 * Generates H5P JSON of Reveal learning object type.
 *
 * @param object $content_object
 *   A Content Object node.
 * @param object $slide
 *   A slide object.
 * Returns array matching the JSON structure
 */
function _content_conversion_node_reveal($learning_object, $slide)
{	
	$element = new stdClass(); //Elements of the slide. In this case, the Click To Reveal option within a Course Presentation.
	
	//Set position & dimension of element within the slide 
	$element->x = 1;
	$element->y = 0;
	$element->width = 97;
	$element->height = 96;
	
	$element->action = new stdClass();
	$element->action->library = 'H5P.ClickToReveal 1.0';
	
	$element->action->params = new stdClass();
	
	//Intro text of learning object to H5P description
	if(isset($learning_object->field_intro) && !empty($learning_object->field_intro))
		$element->action->params->description = $learning_object->field_intro[$learning_object->language][0]['value'];
	else
		$element->action->params->description = t('');
	
	$element->action->params->cards = array();
	
	//Create card objects array iff Reveal collection paragraph bundle is not empty
	if(isset($learning_object->field_reveal_collection) && !empty($learning_object->field_reveal_collection))
	{
		$cards = $learning_object->field_reveal_collection[$learning_object->language]; //Array of cards
		
		/**
		 * foreach Click To Reveal card..
		 *  load the Paragraph entity i.e Reveal collection field in Reveal content type,
		 *  access each of thumbnail, large image & text of the paragraph and
		 *  form the card object and push to the cards array
		 */
		foreach($cards as $card) 
		{
			$cardParagraphEntity = entity_load('paragraphs_item', array($card['value'])); //Borrowed from https://www.drupal.org/node/2510602#comment-10049490
			
			$cardObject = new stdClass();
			
			$cardParagraph = $cardParagraphEntity[$card['value']];
			
			//Thumbnail image object
			if(isset($cardParagraph->field_reveal_thumbnail) && !empty($cardParagraph->field_reveal_thumbnail))
			  $cardObject->thumbnail_image = _create_image_object($cardParagraph->field_reveal_thumbnail[LANGUAGE_NONE][0]);
			
			//Large image object
			if(isset($cardParagraph->field_reveal_hero) && !empty($cardParagraph->field_reveal_hero))
			  $cardObject->large_image = _create_image_object($cardParagraph->field_reveal_hero[LANGUAGE_NONE][0]);
		
			//Text
			if(isset($cardParagraph->field_reveal_text) && !empty($cardParagraph->field_reveal_text))
			{
				$text = $cardParagraph->field_reveal_text[LANGUAGE_NONE][0]['safe_value'];
				$cardObject->text = $text;
			}
			
			$element->action->params->cards[] = $cardObject;
		}
	}
	else
		$element->action->params->cards[] = new stdClass();
	
	//Title of Click to Reveal element
	if(isset($learning_object->field_subtitle) && !empty($learning_object->field_subtitle))
		$element->action->params->title = $learning_object->field_subtitle[$learning_object->language][0]['value'];
	else
		$element->action->params->title = t('');
	
	//Default, constant settings
	$element->action->params->retry = t('Retry');
	$element->action->subContentId = 0;
	$element->alwaysDisplayComments = false;
	$element->backgroundOpacity = 0;
	$element->displayAsButton = false;
	$element->invisible = false;
	$element->solution = "";
	
	$slide->elements[] = $element; //Array of elements
	
	$slide->slideBackgroundSelector = new stdClass(); //Empty since no background image will be selected
	$slide->keywords = array(); //Empty since no keywords will be specified
}

/**
 * Converts a Story node to H5P slide data.
 *
 * @param object $node
 *   A Story node.
 * @param object $slide
 *   H5P data for a single slide.
 */
function _content_conversion_node_hot_spots($node, $slide) {

  $slide->elements = array();
  $slide->slideBackgroundSelector = new stdClass();
  $slide->keywords = array();

  if (!empty($node->field_intro[$node->language][0]['safe_value'])) {
    $get_text_array = array(
      "text" => $node->field_intro[$node->language][0]['safe_value'],
      "x" => '0',
      "y" => '0',
      "width" => '95.329087048832',
      "height" => '66.666666666667',
    );
    $slide->elements[] = _create_text_object($get_text_array);
  }

  //process hotspots
  $slide->elements[] = _create_hotspot_object($node);

  if (!empty($node->field_hot_spot_image[$node->language][0]['uri'])) {
    $element = new stdClass();
    $element->x = 1.0615711252654;
    $element->y = 59.538784067086;
    $element->width = 30.430461002119;
    $element->height = 40;
    $element->alwaysDisplayComments = false;
    $element->backgroundOpacity = 0;
    $element->displayAsButton = false;
    $element->invisible = false;
    $element->solution = '';

    $params = new stdClass();
    $params->contentName = "Image";
    $params->alt = "Hot Spot Image";
    $params->file = _create_image_object($node->field_hot_spot_image[$node->language][0]);

    $action = new stdClass();
    $action->library = "H5P.Image 1.0";
    $action->subContentId = 0;
    $action->params = $params;
    $element->action = $action;
    $slide->elements[] = $element;
  }
}

/*
 * Utility Function
 * _create_hotspot_object - takes a node and returns the necessary element for inserting into a slide
 */
function _create_hotspot_object($node) {

  $element = new stdClass();
  $element->x = 0;
  $element->y = 0;
  $element->width = 99.787685774947;
  $element->height = 99.58071278826;
  $element->alwaysDisplayComments = false;
  $element->backgroundOpacity = 0;
  $element->displayAsButton = false;
  $element->invisible = false;
  $element->solution = '';

  $action = new stdClass();
  $action->library = "H5P.ImageHotspots 1.3";
  $action->subContentId = '0';

  $params = new stdClass();
  $params->color = "ecb328";
  $params->image = _create_image_object($node->field_hot_spot_image[$node->language][0]);

  $hotspots = array();
  foreach($node->field_hot_spot_collection[$node->language] as $key => $value) {
    //load paragraph bundle
    $entity = entity_load('paragraphs_item', array($value['value']));
    $hotspot = $entity[$value['value']];

    $hotspot_object = new stdClass();
    $hotspot_object->alwaysFullscreen = 'false';

    $position_array = array();
    $x_pos = $hotspot->field_hot_spot_x_cordinate['und'][0]['value'];
    $position_array['x'] = $params->image->width * ((ord(strtolower(str_replace("pos","",$x_pos))) - 96)/16);
    $y_pos = $hotspot->field_hot_spot_y_cordinate['und'][0]['value'];
    $position_array['y'] = $params->image->height * (str_replace("pos","",$y_pos)/19);

    $hotspot_object->position = $position_array;

    $content = new stdClass();
    $content->params = array(
      "text" => $hotspot->field_hot_spot_text['und'][0]['safe_value'],
    );
    $content->library = "H5P.Text 1.1";
    $content->subContentId = '0';

    $hotspot_object->content = $content;
    $hotspots[] = $hotspot_object;
  }

  $params->hotspots = $hotspots;
  $action->params = $params;
  $element->action = $action;

  return $element;
}

/*
 * Utility Function
 * _create_image_object - takes an image array and returns a properly formatted file object for h5p conversion
 * receives one drupal image array
 * uri, filemime, height, width
 * returns an image object ready for json conversion
 */
function _create_image_object($image_array) {

  $file = new stdClass();
  $file->path = file_create_url($image_array['uri']);
  $file->mime = $image_array['filemime'];
  $file->width = $image_array['height'];
  $file->height = $image_array['width'];
  $copyright = new stdClass();
  $copyright->license = "U";
  $file->copyright = $copyright;
  return $file;

}

/*
 * Utility Function
 * _create_image_object - takes an image array and returns a properly formatted file object for h5p conversion
 * receives one drupal image array
 * uri, filemime, height, width
 * returns an image object ready for json conversion
 */
function _create_text_object($text_array = null) {

  $element = new stdClass();
  $element->alwaysDisplayComments = false;
  $element->backgroundOpacity = 0;
  $element->displayAsButton = false;
  $element->invisible = false;
  $element->solution = '';

  $element->x = $text_array['x'];
  $element->y = $text_array['y'];
  $element->width = $text_array['width'];
  $element->height = $text_array['height'];

  $action = new stdClass();
  $action->library = "H5P.AdvancedText 1.1";
  $action->subContentId = '0';

  $params = new stdClass();
  $params->text = $text_array['text'];
  if (!empty($text_array['label'])) {
    $params->contentName = $text_array['label'];
  }
  $params->alt = '';
  $action->params = $params;

  $element->action = $action;
  $action->subContentId = 0;

  return $element;
}

/**
 * Created by SUPRIYA RAJGOPAL on 27Aug16
 *
 * Generates H5P JSON of Drag Select learning object type.
 *
 * @param object $content_object
 *   A Content Object node.
 * @param object $slide
 *   A slide object.
 * Returns array matching the JSON structure
 */
function _content_conversion_node_drag_select($learning_object, $slide)
{
	$element = new stdClass(); //Elements of the slide. In this case, the Drag&Drop option within a Course Presentation
	
	//Set position & dimension of element within the slide 
	$element->x = 1;
	$element->y = 0;
	$element->width = 97;
	$element->height = 96;
	
	$element->action = new stdClass();
	$element->action->library = 'H5P.DragQuestion 1.6';
	
	$element->action->params = new stdClass();
	
	//Default, constant settings
	$element->action->params->scoreShow = t('Submit');
	$element->action->params->tryAgain = t('Retry');
	$element->action->params->correct = t('Show solution');
	
	//Correct feedback text
	if(isset($learning_object->field_correct_feedback) && !empty($learning_object->field_correct_feedback))
		$element->action->params->feedback = $learning_object->field_correct_feedback[$learning_object->language][0]['value'];
	else
		$element->action->params->feedback = t('');
	
	//Incorrect feedback text
	if(isset($learning_object->field_incorrect_feeback) && !empty($learning_object->field_incorrect_feeback))
		$element->action->params->incorrect_feedback = $learning_object->field_incorrect_feeback[$learning_object->language][0]['value'];
	else
		$element->action->params->incorrect_feedback = t('');
	
	$element->action->params->question = new stdClass();
	$element->action->params->question->settings = new stdClass();
	$element->action->params->question->settings->size = new stdClass();
	$element->action->params->question->settings->size->width = 800;
	$element->action->params->question->settings->size->width = 500;
	$element->action->params->question->task = new stdClass();
	
	//DRAGGABLE ELEMENT CREATION SECTION
	//Create draggable elements array iff Drag Select collection paragraph bundle is not empty
	if(isset($learning_object->field_drag_select_collection) && !empty($learning_object->field_drag_select_collection))
	{
		$draggables = $learning_object->field_drag_select_collection[$learning_object->language]; //Array of draggable elements
		
		/**
		 * foreach Draggable Element...
		 *  load the Paragraph entity i.e Drag Select collection field in Drag Select content type,
		 *  access each property and
		 *  form the draggable element object and push to the draggableElements array
		 */
		$i = 0; //Index of draggable element. Used to dynamically set 'y' co-ordinate of draggable element arranged vertically
		$correctElements = array(); //The indices of correct answers to be set in dropzone object
		
		foreach($draggables as $draggable)
		{
			$dragSelectParagraphEntity = entity_load('paragraphs_item', array($draggable['value'])); //Borrowed from https://www.drupal.org/node/2510602#comment-10049490
			
			$draggableElement = new stdClass();
			
			$draggableElement->x = 7;
			$draggableElement->y = 6 * ($i + 1); //Starts from '6', gap of '6' between each element
			$draggableElement->width = 18;
			$draggableElement->height = 2;
			
			$dragSelectParagraph = $dragSelectParagraphEntity[$draggable['value']];
			
			$draggableElement->type = new stdClass();
			$draggableElement->type->params = new stdClass();
			
			//If draggable element is an image
			if(isset($dragSelectParagraph->field_drag_select_image) && !empty($dragSelectParagraph->field_drag_select_image))
			{
				$draggableImage = $dragSelectParagraph->field_drag_select_image[LANGUAGE_NONE][0];
				
				$draggableElement->type->library = 'H5P.Image 1.0';
				$draggableElement->type->params->contentName = 'Image';
				$draggableElement->type->params->alt = t('@text',array('@text' => $draggableImage['alt']));
				$draggableElement->type->params->file = _create_image_object($draggableImage);
			}
			
			//If draggable element is text
			if(isset($dragSelectParagraph->field_drag_select_text) && !empty($dragSelectParagraph->field_drag_select_text))
			{
				$draggableElement->type->library = 'H5P.AdvancedText 1.1';
				$draggableElement->type->params->text = t('@text',array('@text' => drupal_html_to_text($dragSelectParagraph->field_drag_select_text[LANGUAGE_NONE][0]['value'])));
			}
			
			//If this is a correct answer
			if(isset($dragSelectParagraph->field_correct_answer) && !empty($dragSelectParagraph->field_correct_answer))
				$isCorrect = $dragSelectParagraph->field_correct_answer[LANGUAGE_NONE][0]['value'];
			else
				$isCorrect = 0;
			
			if($isCorrect)
				array_push($correctElements,strval($i)); //Convert index to string since dropzone section expects string indices as an array
			
			$draggableElement->type->subContentId = 0; //Common to both draggable image &/or text
			
			$draggableElement->dropZones = array("0"); //Which dropzone does this draggable element correctly belong to.In our case, always 1st(0th index) because only 1 dropzone will exist
			$draggableElement->backgroundOpacity = 100;
			$draggableElement->multiple = false;
			
			$element->action->params->question->task->elements[] = $draggableElement;
			
			$i++; //Increment index counter
		}
	}
	
	//DROPZONE CREATION SECTION
	$dropZone = new stdClass();
	$dropZone->x = 50; //Co-ordinates of Dropzone, set to appear on right hand side
	$dropZone->y = 5;
	$dropZone->width = 25;
	$dropZone->height = 30;
	$dropZone->correctElements = $correctElements;
	$dropZone->showLabel = false;
	$dropZone->backgroundOpacity = 100;
	$dropZone->single = false; //Multiple correct elements in dropzone allowed if false, only 1 allowed if true
	$dropZone->label = '<div>Drop Zone</div>\n';
	$dropZone->tip = '';
	$element->action->params->question->task->dropZones[] = $dropZone;
	
	//Question Title
	if(isset($learning_object->field_drag_select_question) && !empty($learning_object->field_drag_select_question))
		$element->action->params->question->settings->questionTitle = t('@text',array('@text' => drupal_html_to_text($learning_object->field_drag_select_question[$learning_object->language][0]['value'])));
	else
		$element->action->params->question->settings->questionTitle = t('');
	
	//Default, constant settings
	$element->action->params->behaviour = new stdClass();
	$element->action->params->behaviour->enableRetry = true;
	$element->action->params->behaviour->singlePoint = false;
	$element->action->params->behaviour->showSolutionsRequiresInput = true;
	$element->action->subContentId = 0;
	$element->alwaysDisplayComments = false;
	$element->backgroundOpacity = 0;
	$element->displayAsButton = false;
	$element->invisible = false;
	$element->solution = "";
	
	$slide->elements[] = $element; //Array of elements
	$slide->slideBackgroundSelector = new stdClass(); //Empty since no background image will be selected
	$slide->keywords = array(); //Empty since no keywords will be specified
}
